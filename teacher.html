<!DOCTYPE html>
<html>
<head>
  <title>Teacher Dashboard</title>
  <style>
    body { 
      font-family: Arial; 
      background:#fff0f5; 
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-height:100vh;
      text-align:center; 
    }
    .logo-bar { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      width:100%; 
      padding:10px 30px; 
      background:#fff; 
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .logo { height:60px; }
    .container {
      margin-top:30px;
      width:90%;
      max-width:900px;
      background:#ffffff;
      padding:20px;
      border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    table { 
      border-collapse:collapse; 
      width:100%; 
      margin-top:20px; 
    }
    th,td { 
      border:1px solid #999; 
      padding:8px; 
      text-align:center; 
    }
    .btn { 
      padding:6px 12px; 
      margin:6px; 
      cursor:pointer; 
      border:none;
      border-radius:6px;
      background:#4CAF50;
      color:white;
    }
    .btn:hover { background:#45a049; }
    select { padding:6px; margin-left:10px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="logo-bar">
    <img src="school.png" class="logo">
    <img src="logo.png" class="logo">
  </div>

  <div class="container">
    <h2>Teacher Dashboard</h2>

    <label>Filter by Class:</label>
    <select id="filterClass" onchange="loadData()">
      <option value="">All</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
    <button class="btn" onclick="exportCSV()">Export CSV</button>

    <table id="studentTable">
      <tr><th>Name</th><th>Class</th><th>Score</th><th>Action</th></tr>
    </table>
    <div id="details"></div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzS3HoeUZ1ncjHKMyNhrySEQ4SXnRN3s4",
      authDomain: "quizapp-8093a.firebaseapp.com",
      databaseURL: "https://quizapp-8093a-default-rtdb.firebaseio.com",
      projectId: "quizapp-8093a",
      storageBucket: "quizapp-8093a.appspot.com",
      messagingSenderId: "903966699269",
      appId: "1:903966699269:web:1de90f50da022cf82f916c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allStudents = [];

    async function loadData() {
      let selectedClass = document.getElementById('filterClass').value;
      allStudents = [];
      document.getElementById('studentTable').innerHTML = "<tr><th>Name</th><th>Class</th><th>Score</th><th>Action</th></tr>";

      const classes = selectedClass ? [selectedClass] : ["4","5","6"];
      for(let cls of classes) {
        const snapshot = await db.ref('results/' + cls).get();
        if(snapshot.exists()) {
          snapshot.forEach(snap=>{
            let studentData = snap.val();
            studentData._id = snap.key;
            allStudents.push(studentData);
            let row = `<tr>
              <td>${studentData.name}</td>
              <td>${studentData.class}</td>
              <td>${studentData.score}</td>
              <td><button class='btn' onclick='viewDetails("${cls}","${snap.key}")'>View</button></td>
            </tr>`;
            document.getElementById('studentTable').innerHTML += row;
          });
        }
      }
      document.getElementById('details').innerHTML="";
    }

    async function viewDetails(classId, studentKey) {
      const snap = await db.ref(`results/${classId}/${studentKey}`).get();
      const s = snap.val();
      let html = `<h3>${s.name} (Class ${s.class}) - Score: ${s.score}</h3>
                  <table><tr><th>Question</th><th>Correct</th><th>Given</th></tr>`;
      s.answers.forEach(a=>{
        let color = (a.correct.toLowerCase() === a.given.toLowerCase()) ? "#c8f7c5" : "#f7c5c5";
        html += `<tr style="background:${color}">
                   <td>${a.q}</td>
                   <td>${a.correct}</td>
                   <td>${a.given}</td>
                 </tr>`;
      });
      html += "</table><br><button class='btn' onclick='backToList()'>Back</button>";
      document.getElementById('details').innerHTML = html;
      document.getElementById('studentTable').style.display="none";
    }

    function backToList() {
      document.getElementById('details').innerHTML="";
      document.getElementById('studentTable').style.display="table";
    }

    function exportCSV() {
      if(allStudents.length===0) { alert("No data to export"); return; }
      let csv = "Name,Class,Score\n";
      allStudents.forEach(s=>{
        csv += `${s.name},${s.class},${s.score}\n`;
      });
      let blob = new Blob([csv], {type: 'text/csv'});
      let link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'quiz_results.csv';
      link.click();
    }

    loadData();
  </script>
</body>
</html>
