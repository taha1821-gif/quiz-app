<!DOCTYPE html>
<html>
<head>
  <title>Teacher Dashboard</title>
  <style>
    body { 
      font-family: Arial, sans-serif;
      background: #f4f9ff;
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
    }
    .logo-bar { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      width:100%; 
      padding:10px 30px; 
      background:#fff; 
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .logo { height:60px; }
    .container {
      margin-top:20px;
      width:90%;
      max-width:1000px;
      background:#ffffff;
      padding:20px;
      border-radius:10px;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    h2 { color:#333; text-align:center; }
    .btn { 
      padding:8px 16px; 
      margin:6px; 
      cursor:pointer; 
      border:none;
      border-radius:6px;
      background:#4CAF50;
      color:white;
      font-size:15px;
    }
    .btn:hover { background:#45a049; }
    .btn-danger { background:#e74c3c; }
    .btn-danger:hover { background:#c0392b; }
    select { padding:6px; margin-left:10px; }

    /* Question Cards */
    .question-list {
      margin-top:20px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:15px;
    }
    .question-card {
      background:#f9f9f9;
      padding:15px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      text-align:left;
    }
    .question-card h4 { margin:0 0 10px 0; color:#333; }
    .delete-btn {
      background:#e74c3c;
      color:white;
      padding:5px 10px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      float:right;
    }
    .delete-btn:hover { background:#c0392b; }
    .section-title {
      margin-top:30px;
      text-align:center;
      color:#444;
    }
    table { 
      border-collapse:collapse; 
      width:100%; 
      margin-top:20px; 
    }
    th,td { 
      border:1px solid #999; 
      padding:8px; 
      text-align:center; 
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="logo-bar">
    <img src="school.png" class="logo">
    <img src="logo.png" class="logo">
  </div>

  <div class="container">
    <h2>Teacher Dashboard</h2>

    <!-- Student Results -->
    <label>Filter by Class:</label>
    <select id="filterClass" onchange="loadResults()">
      <option value="">All</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <button class="btn btn-danger" onclick="clearScores()">Clear Scores</button>

    <table id="studentTable">
      <tr><th>Name</th><th>Class</th><th>Score</th><th>Action</th></tr>
    </table>
    <div id="details"></div>

    <!-- Question Management -->
    <h3 class="section-title">üìö Manage Questions</h3>
    <div style="text-align:center;">
      <button class="btn" onclick="loadQuestions('mcq')">üìò MCQs</button>
      <button class="btn" onclick="loadQuestions('truefalse')">‚úî True/False</button>
      <button class="btn" onclick="loadQuestions('blanks')">‚úç Fill in the Blanks</button>
    </div>
    <div id="questionSection" class="question-list"></div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzS3HoeUZ1ncjHKMyNhrySEQ4SXnRN3s4",
      authDomain: "quizapp-8093a.firebaseapp.com",
      databaseURL: "https://quizapp-8093a-default-rtdb.firebaseio.com",
      projectId: "quizapp-8093a",
      storageBucket: "quizapp-8093a.appspot.com",
      messagingSenderId: "903966699269",
      appId: "1:903966699269:web:1de90f50da022cf82f916c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allStudents = [];

    // ---------------- Results ----------------
    async function loadResults() {
      let selectedClass = document.getElementById('filterClass').value;
      allStudents = [];
      document.getElementById('studentTable').innerHTML = "<tr><th>Name</th><th>Class</th><th>Score</th><th>Action</th></tr>";

      const classes = selectedClass ? [selectedClass] : ["4","5","6"];
      for(let cls of classes) {
        const snapshot = await db.ref('results/' + cls).get();
        if(snapshot.exists()) {
          snapshot.forEach(snap=>{
            let studentData = snap.val();
            studentData._id = snap.key;
            allStudents.push(studentData);
            let row = `<tr>
              <td>${studentData.name}</td>
              <td>${studentData.class}</td>
              <td>${studentData.score}</td>
              <td><button class='btn' onclick='viewDetails("${cls}","${snap.key}")'>View</button></td>
            </tr>`;
            document.getElementById('studentTable').innerHTML += row;
          });
        }
      }
      document.getElementById('details').innerHTML="";
    }

    async function viewDetails(classId, studentKey) {
      const snap = await db.ref(`results/${classId}/${studentKey}`).get();
      const s = snap.val();
      let html = `<h3>${s.name} (Class ${s.class}) - Score: ${s.score}</h3>
                  <table><tr><th>Question</th><th>Correct</th><th>Given</th></tr>`;
      s.answers.forEach(a=>{
        let color = (a.correct.toLowerCase() === a.given.toLowerCase()) ? "#c8f7c5" : "#f7c5c5";
        html += `<tr style="background:${color}">
                   <td>${a.q}</td>
                   <td>${a.correct}</td>
                   <td>${a.given}</td>
                 </tr>`;
      });
      html += "</table><br><button class='btn' onclick='backToList()'>Back</button>";
      document.getElementById('details').innerHTML = html;
      document.getElementById('studentTable').style.display="none";
    }

    function backToList() {
      document.getElementById('details').innerHTML="";
      document.getElementById('studentTable').style.display="table";
    }

    function exportCSV() {
      if(allStudents.length===0) { alert("No data to export"); return; }
      let csv = "Name,Class,Score\n";
      allStudents.forEach(s=>{
        csv += `${s.name},${s.class},${s.score}\n`;
      });
      let blob = new Blob([csv], {type: 'text/csv'});
      let link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'quiz_results.csv';
      link.click();
    }

    // ----------- Clear Scores ------------
    async function clearScores() {
      let selectedClass = document.getElementById('filterClass').value;
      if(selectedClass) {
        if(confirm(`Are you sure you want to clear all scores for Class ${selectedClass}?`)) {
          await db.ref('results/' + selectedClass).remove();
          loadResults();
          alert("Scores cleared for Class " + selectedClass);
        }
      } else {
        if(confirm("‚ö† This will clear ALL scores (all classes). Continue?")) {
          await db.ref('results').remove();
          loadResults();
          alert("All scores cleared.");
        }
      }
    }

    // ---------------- Questions ----------------
    async function loadQuestions(type) {
      const section = document.getElementById("questionSection");
      section.innerHTML = "<p>Loading...</p>";

      const snapshot = await db.ref('questions/' + type).get();
      if(!snapshot.exists()) {
        section.innerHTML = "<p>No questions found.</p>";
        return;
      }

      let html = "";
      snapshot.forEach(snap=>{
        let q = snap.val();
        html += `<div class="question-card">
                  <h4>${q.q}</h4>
                  <button class="delete-btn" onclick="deleteQuestion('${type}','${snap.key}')">Delete</button>`;
        if(type==="mcq" && q.options){
          html += "<ul>";
          q.options.forEach(opt=>{
            html += `<li>${opt}</li>`;
          });
          html += "</ul>";
        }
        if(type==="truefalse"){
          html += `<p>Answer: ${q.answer}</p>`;
        }
        if(type==="blanks"){
          html += `<p>Answer: ${q.answer}</p>`;
        }
        html += `</div>`;
      });
      section.innerHTML = html;
    }

    function deleteQuestion(type, key) {
      if(confirm("Are you sure you want to delete this question?")) {
        db.ref('questions/' + type + '/' + key).remove();
        loadQuestions(type);
      }
    }

    loadResults();
  </script>
</body>
</html>
